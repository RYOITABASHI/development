name: Push to Vault Repository

on:
  push:
    branches: [ main ]
    paths:
      - 'obsidian-ai-chat/mention-test/GOKU/**'
      - 'obsidian-ai-chat/mention-test/VEGETA/**'
  workflow_dispatch:

# ç’°å¢ƒå¤‰æ•°ã®å®šç¾©ã§ä¿å®ˆæ€§ã‚’å‘ä¸Š
env:
  NODE_VERSION: '20'
  GOKU_PATH: 'obsidian-ai-chat/mention-test/GOKU'
  VEGETA_PATH: 'obsidian-ai-chat/mention-test/VEGETA'
  VAULT_REPO: '${{ github.repository_owner }}/obsidian-vault'
  VAULT_BRANCH: 'main'

jobs:
  push-to-vault:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ Checkout Development repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã®å®Œå…¨å–å¾—
        
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          ${{ env.GOKU_PATH }}/package-lock.json
          ${{ env.VEGETA_PATH }}/package-lock.json
        
    - name: ğŸ” Check build prerequisites
      id: check-prerequisites
      run: |
        set -e
        echo "ğŸ” ãƒ“ãƒ«ãƒ‰å‰ææ¡ä»¶ã‚’ç¢ºèªä¸­..."
        
        # package.jsonã®å­˜åœ¨ç¢ºèª
        for plugin in GOKU VEGETA; do
          path="obsidian-ai-chat/mention-test/$plugin"
          if [ ! -f "$path/package.json" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: $path ã« package.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… $plugin: package.json ã‚’ç¢ºèª"
          
          # package-lock.jsonã®å­˜åœ¨ç¢ºèª
          if [ -f "$path/package-lock.json" ]; then
            echo "has_lock_$plugin=true" >> $GITHUB_OUTPUT
            echo "âœ… $plugin: package-lock.json ã‚’ç¢ºèª"
          else
            echo "has_lock_$plugin=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  $plugin: package-lock.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (npm install ã‚’ä½¿ç”¨ã—ã¾ã™)"
          fi
        done
        
    - name: ğŸ—ï¸ Build plugins in parallel with error handling
      run: |
        set -e
        
        # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ããƒ“ãƒ«ãƒ‰é–¢æ•°
        build_plugin() {
          local plugin=$1
          local path="obsidian-ai-chat/mention-test/$plugin"
          local has_lock=$2
          
          echo "ğŸ—ï¸  [$plugin] ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹..."
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
          cd "$GITHUB_WORKSPACE/$path" || {
            echo "âŒ [$plugin] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª $path ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
            return 1
          }
          
          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ“¦ [$plugin] ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          if [ "$has_lock" = "true" ]; then
            npm ci || {
              echo "âŒ [$plugin] npm ci ãŒå¤±æ•—ã—ã¾ã—ãŸ"
              return 1
            }
          else
            npm install || {
              echo "âŒ [$plugin] npm install ãŒå¤±æ•—ã—ã¾ã—ãŸ"
              return 1
            }
          fi
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          echo "ğŸ”¨ [$plugin] ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
          npm run build || {
            echo "âŒ [$plugin] ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            return 1
          }
          
          # distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
          if [ ! -d "dist" ]; then
            echo "âŒ [$plugin] ãƒ“ãƒ«ãƒ‰å¾Œã« dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            return 1
          fi
          
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f "dist/main.js" ]; then
            echo "âŒ [$plugin] dist ã« main.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            return 1
          fi
          
          echo "âœ… [$plugin] ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          return 0
        }
        
        # ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
        echo "ğŸš€ ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹..."
        
        # GOKUãƒ“ãƒ«ãƒ‰
        (build_plugin "GOKU" "${{ steps.check-prerequisites.outputs.has_lock_GOKU }}") &
        GOKU_PID=$!
        
        # VEGETAãƒ“ãƒ«ãƒ‰
        (build_plugin "VEGETA" "${{ steps.check-prerequisites.outputs.has_lock_VEGETA }}") &
        VEGETA_PID=$!
        
        # çµæœã®åé›†
        GOKU_RESULT=0
        VEGETA_RESULT=0
        
        wait $GOKU_PID || GOKU_RESULT=$?
        wait $VEGETA_PID || VEGETA_RESULT=$?
        
        # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if [ $GOKU_RESULT -ne 0 ] || [ $VEGETA_RESULT -ne 0 ]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸï¼"
          [ $GOKU_RESULT -ne 0 ] && echo "  - GOKU ãƒ“ãƒ«ãƒ‰ãŒçµ‚äº†ã‚³ãƒ¼ãƒ‰ $GOKU_RESULT ã§å¤±æ•—"
          [ $VEGETA_RESULT -ne 0 ] && echo "  - VEGETA ãƒ“ãƒ«ãƒ‰ãŒçµ‚äº†ã‚³ãƒ¼ãƒ‰ $VEGETA_RESULT ã§å¤±æ•—"
          exit 1
        fi
        
        echo "âœ… ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        
    - name: ğŸ” Verify build outputs
      run: |
        set -e
        echo "ğŸ” ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã‚’æ¤œè¨¼ä¸­..."
        
        for plugin in GOKU VEGETA; do
          path="obsidian-ai-chat/mention-test/$plugin"
          
          # distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ç¢ºèª
          echo "ğŸ“ [$plugin] dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la "$path/dist/" || {
            echo "âŒ [$plugin] dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸€è¦§å–å¾—ã«å¤±æ•—"
            exit 1
          }
          
          # manifest.jsonã®å­˜åœ¨ç¢ºèªï¼ˆdistã¾ãŸã¯ãƒ«ãƒ¼ãƒˆï¼‰
          if [ -f "$path/dist/manifest.json" ]; then
            echo "âœ… [$plugin] manifest.json ãŒ dist ã«è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          elif [ -f "$path/manifest.json" ]; then
            echo "âœ… [$plugin] manifest.json ãŒãƒ«ãƒ¼ãƒˆã«è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          else
            echo "âŒ [$plugin] manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
        done
        
    - name: ğŸ“¥ Checkout Vault repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.VAULT_REPO }}
        path: vault
        token: ${{ secrets.VAULT_PUSH_TOKEN }}
        ref: ${{ env.VAULT_BRANCH }}
        fetch-depth: 0  # rebaseç”¨ã«å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—
        
    - name: ğŸ“‹ Copy plugins to Vault
      run: |
        set -e
        echo "ğŸ“‹ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ Vault ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ä¸­..."
        
        # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p vault/.obsidian/plugins/goku-multi-chat
        mkdir -p vault/.obsidian/plugins/vegeta-multi-chat
        
        # GOKUã®ã‚³ãƒ”ãƒ¼
        echo "ğŸ“‹ GOKU ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
        cp -r "${{ env.GOKU_PATH }}/dist/"* vault/.obsidian/plugins/goku-multi-chat/
        
        # GOKUã®manifest.jsonãŒç„¡ã„å ´åˆã¯ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼
        if [ ! -f vault/.obsidian/plugins/goku-multi-chat/manifest.json ]; then
          if [ -f "${{ env.GOKU_PATH }}/manifest.json" ]; then
            cp "${{ env.GOKU_PATH }}/manifest.json" vault/.obsidian/plugins/goku-multi-chat/
            echo "âœ… GOKU ã® manifest.json ã‚’ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          fi
        fi
        
        # VEGETAã®ã‚³ãƒ”ãƒ¼
        echo "ğŸ“‹ VEGETA ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
        cp -r "${{ env.VEGETA_PATH }}/dist/"* vault/.obsidian/plugins/vegeta-multi-chat/
        
        # VEGETAã®manifest.jsonãŒç„¡ã„å ´åˆã¯ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼
        if [ ! -f vault/.obsidian/plugins/vegeta-multi-chat/manifest.json ]; then
          if [ -f "${{ env.VEGETA_PATH }}/manifest.json" ]; then
            cp "${{ env.VEGETA_PATH }}/manifest.json" vault/.obsidian/plugins/vegeta-multi-chat/
            echo "âœ… VEGETA ã® manifest.json ã‚’ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          fi
        fi
        
        # æœ€çµ‚ç¢ºèª
        echo "ğŸ” æœ€çµ‚ç¢ºèª..."
        for plugin in goku-multi-chat vegeta-multi-chat; do
          for file in main.js manifest.json; do
            if [ ! -f "vault/.obsidian/plugins/$plugin/$file" ]; then
              echo "âŒ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ« $file ãŒ $plugin ã«ã‚ã‚Šã¾ã›ã‚“"
              exit 1
            fi
          done
          echo "âœ… $plugin: ã™ã¹ã¦ã®å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
        done
        
    - name: ğŸ“¤ Commit and Push to Vault
      working-directory: ./vault
      run: |
        set -e
        
        # Gitè¨­å®š
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global init.defaultBranch main
        
        echo "ğŸ“Š Git ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
        git status
        
        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add .obsidian/plugins/goku-multi-chat
        git add .obsidian/plugins/vegeta-multi-chat
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if git diff --staged --quiet; then
          echo "â„¹ï¸  ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          exit 0
        fi
        
        echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´:"
        git diff --staged --name-status
        
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
        COMMIT_MSG="feat: update Obsidian plugins from ${{ github.sha }}

Updated GOKU and VEGETA plugins from development repository
- GOKU: Multi-chat functionality
- VEGETA: Multi-chat functionality

Source: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
Triggered by: ${{ github.event_name }} on ${{ github.ref_name }}"
        
        # ã‚³ãƒŸãƒƒãƒˆ
        git commit -m "$COMMIT_MSG"
        
        # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        echo "ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
        
        # æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
        for i in 1 2 3; do
          if git push origin HEAD:${{ env.VAULT_BRANCH }}; then
            echo "âœ… Vault ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
            break
          else
            if [ $i -eq 3 ]; then
              echo "âŒ 3å›ã®è©¦è¡Œå¾Œã‚‚ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
            fi
            
            echo "âš ï¸  ãƒ—ãƒƒã‚·ãƒ¥ãŒå¤±æ•—ã—ã¾ã—ãŸ (è©¦è¡Œ $i/3)ã€ç«¶åˆã®è§£æ±ºã‚’è©¦ã¿ã¾ã™..."
            
            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦rebase
            git fetch origin ${{ env.VAULT_BRANCH }}
            
            if git rebase origin/${{ env.VAULT_BRANCH }}; then
              echo "âœ… ãƒªãƒ™ãƒ¼ã‚¹ãŒæˆåŠŸã—ã¾ã—ãŸã€ãƒ—ãƒƒã‚·ãƒ¥ã‚’å†è©¦è¡Œã—ã¾ã™..."
            else
              echo "âŒ ãƒªãƒ™ãƒ¼ã‚¹ãŒå¤±æ•—ã—ã¾ã—ãŸã€ãƒãƒ¼ã‚¸æˆ¦ç•¥ã‚’è©¦ã¿ã¾ã™..."
              git rebase --abort
              git pull origin ${{ env.VAULT_BRANCH }} --strategy=ours
            fi
          fi
        done
        
    - name: ğŸ“Š Summary
      if: always()
      run: |
        echo "ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚µãƒãƒªãƒ¼"
        echo "=================="
        echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo "ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}"
        echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ Vault: ${{ env.VAULT_REPO }}@${{ env.VAULT_BRANCH }}"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æˆåŠŸ"
        else
          echo "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¤±æ•—"
        fi